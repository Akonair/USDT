
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Exlink ThaiQR 收银台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: sans-serif; background: #f0f8ff; padding: 20px; text-align: center; }
    .container { background: #fff; border-radius: 12px; padding: 30px; max-width: 500px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    input { padding: 10px; width: 80%; margin-top: 10px; font-size: 18px; }
    .btn { padding: 12px 24px; margin: 10px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; }
    .btn-primary { background-color: #007BFF; color: white; }
    .btn-secondary { background-color: #00BFA5; color: white; }
    .lang { float: right; }

    /* Modal 样式 */
    .modal {{
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }}
    .modal-content {{
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 80%;
      max-width: 400px;
      text-align: center;
    }}
    .modal-content img {{
      width: 260px;
      margin: 20px 0;
    }}
    .close {{
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }}
    .countdown {{
      font-size: 18px;
      color: #d9534f;
      margin-top: 10px;
    }}
  </style>
</head>
<body>
  <div class="container">
    <div class="lang">
      <select id="langSwitcher" onchange="switchLang()">
        <option value="en">English</option>
        <option value="th">ไทย</option>
      </select>
    </div>
    <h2 id="title">💳 Exlink THB 收银台</h2>
    <p id="desc">请输入金额（例如 500 USD）:</p>
    <input type="number" id="usdAmount" placeholder="USD Amount" />
    <p id="converted">≈ 0 THB</p>
    <button class="btn btn-primary" onclick="payPrivate()"><span id="privateBtn">使用 ThaiQR 私户</span></button>
    <button class="btn btn-secondary" onclick="payPublic()"><span id="publicBtn">使用 ThaiQR 公户</span></button>
  </div>

  <!-- 弹窗 -->
  <div id="qrModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="qrTitle">请扫码支付</h3>
      <img id="qrImage" src="" alt="QR Code"/>
      <p class="countdown" id="countdownText">剩余时间</p>
    </div>
  </div>

  <script>
    const rate = 33.21;
    const accessKey = "FvDHIIaHOzcItJ199qw5Xv6e1izUrAlc";

    document.getElementById("usdAmount").addEventListener("input", function() {
      const usd = parseFloat(this.value || 0);
      const thb = (usd * rate).toFixed(2);
      document.getElementById("converted").innerText = "≈ " + thb + " THB";
    });

    function switchLang() {
      const lang = document.getElementById("langSwitcher").value;
      if (lang === "th") {
        document.getElementById("title").innerText = "💳 ระบบรับชำระ THB ของ Exlink";
        document.getElementById("desc").innerText = "กรุณาใส่จำนวนเงิน (เช่น 500 USD):";
        document.getElementById("privateBtn").innerText = "ใช้บัญชี ThaiQR บุคคลทั่วไป";
        document.getElementById("publicBtn").innerText = "ใช้บัญชี ThaiQR บริษัท";
      } else {
        document.getElementById("title").innerText = "💳 Exlink THB 收银台";
        document.getElementById("desc").innerText = "请输入金额（例如 500 USD）:";
        document.getElementById("privateBtn").innerText = "使用 ThaiQR 私户";
        document.getElementById("publicBtn").innerText = "使用 ThaiQR 公户";
      }
    }

    function generateSignature(params, key) {
      const keys = Object.keys(params).sort();
      let str = keys.map(k => `${k}=${params[k]}`).join("&");
      str += `&key=${key}`;
      return md5(str);
    }

    function pay(channel) {
      const usd = parseFloat(document.getElementById("usdAmount").value || 0);
      const thb = (usd * rate).toFixed(2);
      const isPublic = (channel === "TPScanQRCode");
      const data = {
        uid: 5588368,
        bankCode: isPublic ? "003" : "AllBanksSupported",
        amount: thb,
        currencyCoinName: "THB",
        channelCode: channel,
        paymentMethod: 3,
        merchantOrderNo: "THBceshi-" + Date.now()
      };
      if (isPublic) {
        data.paymentCardNumber = "1234567890123456";
        data.paymentName = "John Doe";
      }

      data.signature = generateSignature(data, accessKey);

      fetch("https://api.exlinked.global/coin/pay/recharge/order/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(res => {
        if (res.success && res.data && res.data.qrcode) {
          showModal(res.data.qrcode, isPublic ? 20 : 7);
        } else {
          alert("创建订单失败：" + res.message);
        }
      });
    }

    function payPrivate() { pay("THBScanQRCode"); }
    function payPublic() { pay("TPScanQRCode"); }

    function showModal(qr, minutes) {
      document.getElementById("qrImage").src = "https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=" + encodeURIComponent(qr);
      document.getElementById("qrModal").style.display = "block";
      let seconds = minutes * 60;
      const timer = setInterval(() => {
        if (seconds <= 0) {
          document.getElementById("countdownText").innerText = "二维码已过期";
          clearInterval(timer);
        } else {
          const m = Math.floor(seconds / 60), s = seconds % 60;
          document.getElementById("countdownText").innerText = `剩余时间：${m}分${s}秒`;
          seconds--;
        }
      }, 1000);
    }

    function closeModal() {
      document.getElementById("qrModal").style.display = "none";
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script>
</body>
</html>
